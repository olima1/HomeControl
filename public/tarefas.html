<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Minhas Tarefas</title>
    <link rel="stylesheet" href="CSS/style.css">
</head>
<body>
    <nav>
        <a href="tarefas.html">Minhas Tarefas</a> |
        <a href="shopping.html">Lista de Compras</a>
    </nav>
    
    <h1>Minhas Tarefas</h1>

    <div class="container">
        <h2>Criar Nova Tarefa</h2>
        <form id="createTaskForm" class="create-form">
            <input type="text" id="taskName" placeholder="Nome da Tarefa" required>
            <input type="date" id="taskDueDate">
            <select id="taskAssigneeSelect"></select>
            <button type="submit">Criar</button>
        </form>
    </div>

    <div class="container">
        <h2>Tarefas Pendentes</h2>
        <ul id="pendingTaskList" class="task-list"></ul>
    </div>

    <div class="container">
        <h2>Tarefas Concluídas</h2>
        <ul id="completedTaskList" class="task-list"></ul>
    </div>
    
    <div id="message" class="message hidden"></div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadUsersDropdown();
            fetchPendingTasks();
            fetchCompletedTasks();
        });

        const createTaskForm = document.getElementById("createTaskForm");
        const pendingTaskList = document.getElementById("pendingTaskList");
        const completedTaskList = document.getElementById("completedTaskList");
        const messageElement = document.getElementById("message");
        const taskAssigneeSelect = document.getElementById("taskAssigneeSelect");

        async function fetchPendingTasks() {
            try {
                const response = await fetch("/api/tasks.js");
                if (response.ok) {
                    const tasks = await response.json();
                    renderTasks(tasks, pendingTaskList);
                } else {
                    showMessage("Erro ao carregar tarefas pendentes.", "error");
                }
            } catch (error) {
                showMessage("Erro de conexão com a API.", "error");
            }
        }

        async function fetchCompletedTasks() {
            try {
                const response = await fetch("/api/completed-tasks.js");
                if (response.ok) {
                    const tasks = await response.json();
                    renderTasks(tasks, completedTaskList);
                } else {
                    showMessage("Erro ao carregar tarefas concluídas.", "error");
                }
            } catch (error) {
                showMessage("Erro de conexão com a API.", "error");
            }
        }

        async function loadUsersDropdown() {
            try {
                const response = await fetch("/api/users.js");
                if (response.ok) {
                    const { users } = await response.json();
                    taskAssigneeSelect.innerHTML = "";
                    users.forEach(username => {
                        const option = document.createElement("option");
                        option.value = username;
                        option.textContent = username;
                        taskAssigneeSelect.appendChild(option);
                    });
                } else {
                    showMessage("Erro ao carregar a lista de usuários.", "error");
                }
            } catch (error) {
                showMessage("Erro de conexão ao carregar usuários.", "error");
            }
        }

        function renderTasks(tasks, listElement) {
            listElement.innerHTML = "";
            tasks.forEach(task => {
                const li = document.createElement("li");
                li.className = task.completed ? "completed" : "";
                
                let dueDate = "";
                if (task.due_date) {
                    const date = new Date(task.due_date);
                    dueDate = `(${date.toLocaleDateString()})`;
                }

                const assignee = task.assignee ? ` - para ${task.assignee}` : '';

                li.innerHTML = `
                    <span>${task.name} ${dueDate} ${assignee}</span>
                    <div>
                        <input type="checkbox" ${task.completed ? "checked" : ""} 
                               onclick="toggleTaskStatus(${task.id}, this.checked)">
                        <button onclick="deleteTask(${task.id})">Excluir</button>
                    </div>
                `;
                listElement.appendChild(li);
            });
        }

        createTaskForm.addEventListener("submit", async function(event) {
            event.preventDefault();
            const name = document.getElementById("taskName").value;
            const dueDate = document.getElementById("taskDueDate").value;
            const assignee = taskAssigneeSelect.value; 

            try {
                const response = await fetch("/api/create-task.js", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, dueDate, assignee })
                });

                if (response.ok) {
                    createTaskForm.reset();
                    fetchPendingTasks();
                    showMessage("Tarefa criada com sucesso!", "success");
                } else {
                    const error = await response.json();
                    showMessage(`Erro ao criar tarefa: ${error.error}`, "error");
                }
            } catch (error) {
                showMessage("Erro de conexão com a API.", "error");
            }
        });

        async function toggleTaskStatus(taskId, isCompleted) {
            try {
                const response = await fetch("/api/update-task-status.js", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ taskId, completed: isCompleted })
                });

                if (response.ok) {
                    fetchPendingTasks();
                    fetchCompletedTasks();
                } else {
                    showMessage("Erro ao atualizar status.", "error");
                }
            } catch (error) {
                showMessage("Erro de conexão.", "error");
            }
        }

        async function deleteTask(taskId) {
            if (!confirm("Tem certeza que deseja excluir esta tarefa?")) return;
            try {
                const response = await fetch(`/api/delete-task.js?taskId=${taskId}`, {
                    method: "DELETE"
                });

                if (response.ok) {
                    fetchPendingTasks();
                    fetchCompletedTasks();
                    showMessage("Tarefa excluída com sucesso!", "success");
                } else {
                    showMessage("Erro ao excluir tarefa.", "error");
                }
            } catch (error) {
                showMessage("Erro de conexão.", "error");
            }
        }
        
        function showMessage(text, type) {
            messageElement.textContent = text;
            messageElement.className = `message ${type}`;
            setTimeout(() => {
                messageElement.classList.add("hidden");
            }, 5000);
        }
    </script>
</body>
</html>